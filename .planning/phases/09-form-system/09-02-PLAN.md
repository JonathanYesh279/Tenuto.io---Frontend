---
phase: 09-form-system
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - src/components/modals/AddTeacherModal.tsx
  - src/styles/teacher-modal-fixes.css
autonomous: true

must_haves:
  truths:
    - "Submitting AddTeacherModal with missing required firstName shows a red border on the firstName field and an error message directly beneath it — no generic alert banner for field-level errors"
    - "Every form field in AddTeacherModal has a visible label that stays visible regardless of whether the field has a value"
    - "Switching between all 7 tabs in AddTeacherModal retains every field's value — no data loss from tab navigation"
    - "All native <select> elements in AddTeacherModal are replaced with shadcn Radix Select — zero native selects remain"
    - "The teacher-modal-fixes.css .teacher-student-select option !important block is removed after Select migration"
    - "Save button appears at bottom-right in RTL with Cancel to its right (outward) — consistent with OrchestraForm pattern"
  artifacts:
    - path: "src/components/modals/AddTeacherModal.tsx"
      provides: "7-tab teacher create/edit form with RHF + shadcn primitives"
    - path: "src/styles/teacher-modal-fixes.css"
      provides: "CSS with native select hacks removed"
  key_links:
    - from: "src/components/modals/AddTeacherModal.tsx"
      to: "src/components/ui/form-field.tsx"
      via: "import { FormField }"
      pattern: "import.*FormField.*from.*form-field"
    - from: "src/components/modals/AddTeacherModal.tsx"
      to: "react-hook-form"
      via: "import { useForm, Controller }"
      pattern: "import.*useForm.*Controller.*from.*react-hook-form"
    - from: "src/components/modals/AddTeacherModal.tsx"
      to: "src/components/ui/select.tsx"
      via: "import { Select, SelectTrigger, ... }"
      pattern: "import.*Select.*from.*ui/select"
---

<objective>
Migrate AddTeacherModal to React Hook Form (for tab data persistence) and replace all native inputs with shadcn/ui-styled components wrapped in FormField.

Purpose: This is the most complex form in the app (1227 lines, 7 tabs). RHF's `shouldUnregister: false` (default) is the canonical solution for preserving field values across tab switches. The shadcn primitive swap + FormField wrapper brings visual consistency and inline validation.

Output: AddTeacherModal fully migrated to RHF + shadcn primitives, teacher-modal-fixes.css cleaned of native select hacks.
</objective>

<execution_context>
@/home/yona279/.claude/get-shit-done/workflows/execute-plan.md
@/home/yona279/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-form-system/09-RESEARCH.md
@.planning/phases/09-form-system/09-01-SUMMARY.md

@src/components/modals/AddTeacherModal.tsx
@src/styles/teacher-modal-fixes.css
@src/components/ui/form-field.tsx
@src/components/ui/input.tsx
@src/components/ui/select.tsx
@src/components/ui/checkbox.tsx
@src/components/ui/switch.tsx
@src/components/ui/button.tsx
@src/components/ui/separator.tsx
@src/constants/enums.ts
@src/constants/locations.ts
@src/utils/validationUtils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate AddTeacherModal to React Hook Form with Controller</name>
  <files>
    src/components/modals/AddTeacherModal.tsx
  </files>
  <action>
**This is a large migration (~1227 lines). Work methodically tab-by-tab.**

**Step 1: Add RHF imports and setup**

Replace the `useState`-based form state with React Hook Form's `useForm`:

```typescript
import { useForm, Controller, useFieldArray } from 'react-hook-form'
```

Initialize with:
```typescript
const { control, handleSubmit, formState: { errors }, reset, setValue, watch, getValues } = useForm<TeacherFormData>({
  defaultValues: { /* existing default shape from current resetForm() */ },
  mode: 'onTouched', // validate after first touch, then live
  // shouldUnregister: false is the DEFAULT — tab switching safe
})
```

**CRITICAL — Data persistence guarantee:** RHF's default `shouldUnregister: false` means when a tab unmounts (because `{activeTab === 'personal' && (...)}` hides it), the values are retained in RHF's internal store. This is the key fix for success criterion #3.

**Step 2: Remove old useState-based form state**

Remove:
- `const [formData, setFormData] = useState<TeacherFormData>({...})`
- `const [errors, setErrors] = useState<Record<string, string>>({})`
- The `handleInputChange` function
- The `resetForm` function (replace with RHF's `reset()`)

Keep:
- `const [activeTab, setActiveTab]` — tab navigation is separate from form state
- `const [orchestras, setOrchestras]` — these are fetched data, not form fields
- `const [ensembles, setEnsembles]` — same
- `const [isSubmitting, setIsSubmitting]` — RHF has `formState.isSubmitting` but keeping manual control is fine for the async submit
- `const [submitError, setSubmitError]` — server error display

**Step 3: Convert form submission**

Replace the existing `handleSubmit` with RHF's pattern:
```typescript
const onSubmit = async (data: TeacherFormData) => {
  setIsSubmitting(true)
  setSubmitError('')
  try {
    // Transform schedule slots to timeBlocks (same logic as before)
    const newTimeBlocks = data.teaching.schedule.map(slot => ({...}))
    // ... rest of existing submit logic using `data` instead of `formData`
  } catch (error) {
    // ... existing error handling
  } finally {
    setIsSubmitting(false)
  }
}
```

Wrap form: `<form onSubmit={handleSubmit(onSubmit)}>`

**Step 4: Convert edit mode data loading**

Replace `loadTeacherData` to use RHF's `reset()`:
```typescript
const loadTeacherData = (teacher: any) => {
  reset({
    personalInfo: {
      firstName: teacher.personalInfo?.firstName || teacher.firstName || '',
      lastName: teacher.personalInfo?.lastName || teacher.lastName || '',
      // ... same mapping logic
    },
    // ... rest of existing mapping
  })
}
```

**Step 5: Migrate each tab's fields**

For each tab, replace native inputs with shadcn + FormField + Controller:

**Personal Info tab (6 text inputs):**
Each text input becomes:
```tsx
<Controller
  name="personalInfo.firstName"
  control={control}
  rules={{ required: 'שם פרטי הוא שדה חובה' }}
  render={({ field, fieldState }) => (
    <FormField label="שם פרטי" htmlFor="firstName" error={fieldState.error?.message} required>
      <Input
        id="firstName"
        {...field}
        aria-invalid={!!fieldState.error}
        aria-describedby={fieldState.error ? 'firstName-error' : undefined}
        className={cn(fieldState.error && "border-destructive focus-visible:ring-destructive")}
        placeholder="הכנס שם פרטי"
      />
    </FormField>
  )}
/>
```

Fields: firstName*, lastName*, phone, email, address, idNumber, birthYear (number).
For birthYear: `<Input type="number" {...field} onChange={(e) => field.onChange(e.target.value ? parseInt(e.target.value) : null)} />`

**Professional Info tab (2 selects + 2 checkboxes + 1 number input):**

Replace `<select>` for classification and degree with:
```tsx
<Controller
  name="professionalInfo.classification"
  control={control}
  render={({ field, fieldState }) => (
    <FormField label="סיווג" htmlFor="classification" error={fieldState.error?.message}>
      <Select value={field.value || undefined} onValueChange={field.onChange}>
        <SelectTrigger id="classification" className={cn(fieldState.error && "border-destructive")}>
          <SelectValue placeholder="בחר סיווג" />
        </SelectTrigger>
        <SelectContent>
          {CLASSIFICATIONS.map(c => (
            <SelectItem key={c} value={c}>{c}</SelectItem>
          ))}
        </SelectContent>
      </Select>
    </FormField>
  )}
/>
```

Replace checkboxes (hasTeachingCertificate, isUnionMember) with shadcn Checkbox + Controller:
```tsx
<Controller
  name="professionalInfo.hasTeachingCertificate"
  control={control}
  render={({ field }) => (
    <div className="flex items-center gap-2">
      <Checkbox id="hasTeachingCertificate" checked={field.value} onCheckedChange={field.onChange} />
      <Label htmlFor="hasTeachingCertificate">תעודת הוראה</Label>
    </div>
  )}
/>
```

**Instruments tab (instrument select + multi-select instruments):**

Replace the primary instrument `<select>` with shadcn Select. For instruments[] array (multi-select checkboxes), use Controller wrapping checkbox list — same pattern as current implementation but with shadcn Checkbox.

**CRITICAL for instruments:** The grouped instrument display uses INSTRUMENT_DEPARTMENTS from enums. Use SelectGroup + SelectLabel pattern:
```tsx
<SelectContent>
  {Object.entries(INSTRUMENT_DEPARTMENTS).map(([dept, instruments]) => (
    <SelectGroup key={dept}>
      <SelectLabel>{dept}</SelectLabel>
      {instruments.map(inst => (
        <SelectItem key={inst} value={inst}>{inst}</SelectItem>
      ))}
    </SelectGroup>
  ))}
</SelectContent>
```

**Subjects tab (teachingSubjects multi-select):**
Use Controller wrapping checkbox list with shadcn Checkbox. Same pattern as instruments multi-select.

**Management tab (role select + 4 number inputs):**
Replace role `<select>` with shadcn Select. Replace number inputs with shadcn Input type="number". All wrapped in FormField.

**Schedule tab (array of schedule slots):**
Each slot has: day select, startTime input, endTime input, location select, notes input, remove button.
Use Controller for each field within the slot. For day and location selects, use shadcn Select.
Keep the "Add Time Slot" button but style with shadcn Button variant="outline".

**Conducting tab (orchestra/ensemble checkboxes):**
Replace native checkboxes with shadcn Checkbox + Controller. The orchestras and ensembles lists are fetched separately — use Controller with checkbox arrays.

**Step 6: Update section headings**

Add Separator-based section headings within tabs where logical groupings exist. Keep the existing tab icon + label pattern in the tab navigation bar.

**Step 7: Replace hardcoded color classes with tokens**

Same token replacement as OrchestraForm:
- `text-gray-700/500/900` → `text-foreground` / `text-muted-foreground`
- `border-gray-200/300` → `border-border` / `border-input`
- `bg-white` → `bg-background` / `bg-card`
- `border-red-300` → `border-destructive`
- `text-red-500/600` → `text-destructive`
- `focus:ring-primary-500` → no change needed (Input has focus-visible:ring-ring)
- `hover:bg-gray-100` → `hover:bg-muted`

**Step 8: Update button section**

Replace native buttons with shadcn Button:
- Cancel: `<Button type="button" variant="outline" onClick={handleClose} disabled={isSubmitting}>ביטול</Button>`
- Save: `<Button type="submit" disabled={isSubmitting}>...text...</Button>`

**IMPORTANT — Avoid these pitfalls:**
- Radix Select does NOT accept empty string as value. Use `value={field.value || undefined}` for optional selects.
- Radix Checkbox uses `checked`/`onCheckedChange`, not `value`/`onChange`. Always destructure explicitly in Controller render.
- For number fields, `field.onChange` receives a string from input — use `parseInt()` or `parseFloat()` at the onChange boundary.
- Keep `shouldUnregister: false` (the default) — never set it to true.
- Tab navigation buttons are NOT submit buttons — they must remain `type="button"` or just `onClick` handlers.
- The tab navigation bar (custom buttons) should NOT be replaced with shadcn Tabs — the form is already in a raw modal, and the tab buttons control which section is visible. Changing to shadcn Tabs would require restructuring the form layout which is out of scope.
- Preserve the existing submit data transformation logic (schedule slots → timeBlocks, etc.) exactly as-is.
- Keep backward-compat for `loadTeacherData` (handles both fullName and firstName/lastName).
  </action>
  <verify>
1. Run `npx tsc --noEmit 2>&1 | grep "AddTeacherModal" | head -20` — zero TypeScript errors
2. Run `grep -c '<select' src/components/modals/AddTeacherModal.tsx` — should return 0
3. Run `grep -c 'FormField' src/components/modals/AddTeacherModal.tsx` — should be >= 10
4. Run `grep -c 'Controller' src/components/modals/AddTeacherModal.tsx` — should be >= 8
5. Run `grep 'useForm' src/components/modals/AddTeacherModal.tsx` — should appear (RHF integration)
6. Run `grep 'shouldUnregister' src/components/modals/AddTeacherModal.tsx` — should NOT appear (default is correct)
7. Run `grep -c 'teacher-student-select' src/components/modals/AddTeacherModal.tsx` — should return 0
  </verify>
  <done>
AddTeacherModal uses React Hook Form with Controller for all fields. Tab switching preserves all field values via RHF's default shouldUnregister:false. All native `<select>` replaced with shadcn Radix Select. All fields wrapped in FormField with visible labels and inline error messages. Hardcoded color classes replaced with design tokens. Buttons use shadcn Button. No regressions in form submission or data transformation logic.
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean up teacher-modal-fixes.css native select hacks</name>
  <files>
    src/styles/teacher-modal-fixes.css
  </files>
  <action>
After Task 1 migrates all native `<select>` to Radix Select, clean up the CSS:

1. **Remove the entire `.teacher-student-select option` block** (lines 14-28 in current file):
   ```css
   /* REMOVE all of these: */
   .teacher-student-select option { ... !important ... }
   .teacher-student-select option:hover { ... !important ... }
   .teacher-student-select option:checked { ... !important ... }
   ```

2. **Remove the `.teacher-student-select` base styling** (lines 6-9 and 61-69):
   - The `color-scheme: light`, `appearance: none`, `background-image` (chevron SVG), and custom padding rules are all for native `<select>` — Radix Select renders its own dropdown and doesn't need any of this.
   - Remove BOTH `.teacher-student-select` blocks entirely.

3. **Remove the TODO(Phase 9) comment** (line 12-13).

4. **Keep the rest of the file** (teacher-modal-button focus states, teacher-modal-backdrop, teacher-modal-label, teacher-search-dropdown scrollbar, teacher-search-option, teacher-search-input, teacher-dropdown-enter animation, mobile responsive rules). These are still used for non-select elements in the modal.

5. **Verify no remaining class references:** After cleanup, confirm that `teacher-student-select` class is no longer referenced in AddTeacherModal.tsx (should have been removed in Task 1 when native selects were replaced).
  </action>
  <verify>
1. Run `grep -c 'teacher-student-select' src/styles/teacher-modal-fixes.css` — should return 0
2. Run `grep -c '!important' src/styles/teacher-modal-fixes.css` — should return 0 (all !important were in the option blocks)
3. Run `grep -c 'teacher-student-select' src/components/modals/AddTeacherModal.tsx` — should return 0
4. Run `grep 'TODO.*Phase 9' src/styles/teacher-modal-fixes.css` — should return nothing
  </verify>
  <done>
teacher-modal-fixes.css has zero `.teacher-student-select` rules, zero `!important` overrides, and zero Phase 9 TODOs. The file retains only the button, backdrop, label, search dropdown, and mobile responsive styles that are still in use.
  </done>
</task>

</tasks>

<verification>
1. Zero native `<select>` in AddTeacherModal (`grep -c '<select' src/components/modals/AddTeacherModal.tsx` = 0)
2. RHF integrated (`grep 'useForm' src/components/modals/AddTeacherModal.tsx` finds match)
3. All fields wrapped in FormField (`grep -c 'FormField' src/components/modals/AddTeacherModal.tsx` >= 10)
4. Zero `!important` in teacher-modal-fixes.css
5. Zero `teacher-student-select` class references anywhere
6. TypeScript compiles for AddTeacherModal
</verification>

<success_criteria>
- Tab switching preserves form data (RHF shouldUnregister default = false)
- Every field has a visible label via FormField wrapper
- Missing required field shows red border + error message inline
- Save/Cancel buttons use shadcn Button with consistent RTL placement
- teacher-modal-fixes.css is cleaned of all native select CSS hacks
</success_criteria>

<output>
After completion, create `.planning/phases/09-form-system/09-02-SUMMARY.md`
</output>
