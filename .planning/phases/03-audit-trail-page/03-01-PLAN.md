---
phase: 3
plan: 1
wave: 1
title: Build Audit Trail page with API service, routing, and sidebar nav
autonomous: true
---

# Plan 03-01: Audit Trail Page

**Phase:** 3 — Audit Trail Page
**Goal:** Admins can view deletion logs and past activities through a dedicated UI
**Requirements:** AUDIT-01, AUDIT-02, AUDIT-03, AUDIT-04

## Context

### Backend Endpoints (already live)

**Deletion Audit Log:** `GET /api/admin/deletion/audit-log`
- Query params: startDate, endDate, action, entityType, status, limit (default 100), page (default 1), sortBy, sortOrder
- Response: `{ success, data: { auditEntries: [...], pagination: { page, limit, total, pages }, summary: { totalOperations, successfulOperations } } }`

**Past Activities:** `GET /api/admin/past-activities`
- Query params: type ('all'|'rehearsals'|'theory'|'private-lessons'), teacherId, startDate, endDate, limit (default 100), page (default 1)
- Response: paginated list of activities

**Past Activities by Type:** `GET /api/admin/past-activities/:type`
- Path param: type ('rehearsals'|'theory'|'private-lessons')
- Query params: teacherId, studentId, orchestraId, category, startDate, endDate, limit, page

**Snapshots:** `GET /api/admin/deletion/snapshots`
- Response: `{ success, data: { snapshots: [...] } }`

### Frontend Patterns to Follow
- Lazy loading: `const AuditTrail = lazyWithRetry(() => import('./pages/AuditTrail'), 'AuditTrail')`
- Route pattern: inside admin ProtectedRoute block in App.tsx
- Sidebar: add to admin nav items array, use lucide-react icons
- API service: add to `src/services/apiService.js` after existing services
- Styling: Tailwind CSS, RTL-first, Hebrew labels
- Table: use the project's existing Table component at `src/components/ui/Table.tsx` OR simple Tailwind table
- Error/loading/empty states: Hebrew messages

## Tasks

### Task 1: Add adminAuditService to apiService.js
**File:** `src/services/apiService.js`
Add after the last service export (around line 5200+):

```js
export const adminAuditService = {
  getAuditLog: (params) => api.get('/admin/deletion/audit-log', { params }),
  getPastActivities: (params) => api.get('/admin/past-activities', { params }),
  getPastActivitiesByType: (type, params) => api.get(`/admin/past-activities/${type}`, { params }),
  getSnapshots: () => api.get('/admin/deletion/snapshots'),
}
```

**Commit:** "Add adminAuditService to apiService.js"

### Task 2: Create AuditTrail.tsx page
**File:** `src/pages/AuditTrail.tsx`

Build a page with:
- Two tabs: "יומן מחיקות" (Deletion Log) and "פעילויות עבר" (Past Activities)
- Use `useState` for active tab

**Deletion Log tab (Tab 1):**
- Date range filter: two date inputs (מתאריך / עד תאריך)
- Entity type dropdown filter: all/teacher/student/orchestra (כל הסוגים/מורה/תלמיד/תזמורת)
- Table columns: תאריך (date) | פעולה (action) | סוג (entity type) | שם (entity name) | מנהל (admin) | סטטוס (status)
- Pagination controls (previous/next) using backend page/limit params
- Show `pagination.total` count

**Past Activities tab (Tab 2):**
- Type filter dropdown: all/rehearsals/theory/private-lessons (הכל/חזרות/תיאוריה/שיעורים פרטיים)
- Table columns: תאריך (date) | סוג (type) | פרטים (details) | מורה (teacher) | תלמידים (students)
- Pagination controls

**Both tabs:**
- Loading spinner during fetch
- Error state: red banner with Hebrew message, retry button
- Empty state: "לא נמצאו רשומות" with appropriate icon
- Use `useEffect` to fetch on filter/page change

**Commit:** "Add AuditTrail page with deletion log and past activities tabs"

### Task 3: Add route and lazy import in App.tsx
**File:** `src/App.tsx`

1. Add lazy import near other page imports (around line 29):
   `const AuditTrail = lazyWithRetry(() => import('./pages/AuditTrail'), 'AuditTrail')`

2. Add route inside admin ProtectedRoute section:
   `<Route path="audit-trail" element={<AuditTrail />} />`

**Commit:** "Add audit-trail route to App.tsx"

### Task 4: Add sidebar navigation item
**File:** `src/components/Sidebar.tsx`

1. Import `Shield` from lucide-react (already imported, verify)
2. Add to admin nav items array:
   `{ name: 'יומן ביקורת', href: '/audit-trail', icon: Shield, category: 'admin', roles: ['admin'] }`

**Commit:** "Add audit trail to sidebar navigation"

### Task 5: Build verification
Run `npm run build` to confirm everything compiles.

## Verification

- [ ] adminAuditService exists in apiService.js with 4 methods
- [ ] AuditTrail.tsx renders with two tabs
- [ ] Deletion Log tab has date range + entity type filters + paginated table
- [ ] Past Activities tab has type filter + paginated table
- [ ] Loading/error/empty states work with Hebrew messages
- [ ] Route at /audit-trail with admin ProtectedRoute
- [ ] Sidebar shows "יומן ביקורת" for admin users
- [ ] `npm run build` passes clean
