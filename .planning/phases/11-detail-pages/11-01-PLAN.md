---
phase: 11-detail-pages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/avatarColorHash.ts
  - src/components/domain/AvatarInitials.tsx
  - src/components/domain/DetailPageHeader.tsx
  - src/components/domain/index.ts
  - src/features/teachers/details/components/TeacherDetailsPage.tsx
  - src/features/students/details/components/StudentDetailsPage.tsx
autonomous: true

must_haves:
  truths:
    - "Teacher detail page shows a warm gradient strip header with teacher's initials in a colored circle and role badge"
    - "Student detail page shows a warm gradient strip header with student's initials in a colored circle"
    - "Avatar color for a given name is always the same (deterministic hash, not random)"
    - "Teacher breadcrumb reads 'מורים > יוני כהן' and links back to /teachers"
    - "Student breadcrumb reads 'תלמידים > שם תלמיד' and links back to /students"
    - "'עודכן לאחרונה: DD בMMMM YYYY' appears beneath entity name when updatedAt exists"
    - "Switching tabs on Teacher page shows 200ms fade transition between content"
    - "Switching tabs on Student page shows 200ms fade transition between content"
  artifacts:
    - path: "src/utils/avatarColorHash.ts"
      provides: "Deterministic name-to-color mapping"
      exports: ["getAvatarColorClasses"]
    - path: "src/components/domain/DetailPageHeader.tsx"
      provides: "Shared gradient header with avatar, breadcrumb, badges, updatedAt"
      exports: ["DetailPageHeader"]
    - path: "src/components/domain/AvatarInitials.tsx"
      provides: "Extended AvatarInitials with optional colorClassName prop"
      exports: ["AvatarInitials"]
  key_links:
    - from: "src/components/domain/DetailPageHeader.tsx"
      to: "src/utils/avatarColorHash.ts"
      via: "import and call getAvatarColorClasses(displayName)"
      pattern: "getAvatarColorClasses"
      verify: "grep -c 'getAvatarColorClasses' src/components/domain/DetailPageHeader.tsx"
    - from: "src/components/domain/DetailPageHeader.tsx"
      to: "src/components/domain/AvatarInitials.tsx"
      via: "import AvatarInitials"
      pattern: "AvatarInitials"
    - from: "src/features/teachers/details/components/TeacherDetailsPage.tsx"
      to: "src/components/domain/DetailPageHeader.tsx"
      via: "import DetailPageHeader"
      pattern: "DetailPageHeader"
    - from: "src/features/students/details/components/StudentDetailsPage.tsx"
      to: "src/components/domain/DetailPageHeader.tsx"
      via: "import DetailPageHeader"
      pattern: "DetailPageHeader"
---

<objective>
Build the shared detail page header infrastructure (avatar color hash, DetailPageHeader component) and wire it into Teacher and Student detail pages with gradient headers, breadcrumbs, updatedAt metadata, and tab fade transitions.

Purpose: Gives Teacher and Student detail views consistent, branded structure with music-school identity instead of generic white cards.
Output: avatarColorHash utility, enhanced AvatarInitials, DetailPageHeader component, upgraded TeacherDetailsPage and StudentDetailsPage.
</objective>

<execution_context>
@/home/yona279/.claude/get-shit-done/workflows/execute-plan.md
@/home/yona279/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-detail-pages/11-RESEARCH.md
@src/components/domain/AvatarInitials.tsx
@src/components/domain/index.ts
@src/components/ui/tabs.tsx
@src/features/teachers/details/components/TeacherDetailsPage.tsx
@src/features/students/details/components/StudentDetailsPage.tsx
@src/index.css (CSS custom properties — --primary: 15 85% 45%, --accent: 35 90% 55%)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create avatar color hash utility, extend AvatarInitials, build DetailPageHeader</name>
  <files>
    src/utils/avatarColorHash.ts
    src/components/domain/AvatarInitials.tsx
    src/components/domain/DetailPageHeader.tsx
    src/components/domain/index.ts
  </files>
  <action>
**1. Create `src/utils/avatarColorHash.ts`:**

Export `getAvatarColorClasses(name: string): { bg: string; text: string }`.

Algorithm: Sum all char codes of the name string, modulo palette length, index into palette array. If name is empty/falsy, return palette[0].

Use 8 warm colors (all text-white for contrast):
- bg-amber-500
- bg-orange-500
- bg-teal-500
- bg-rose-500
- bg-emerald-500
- bg-violet-500
- bg-sky-500
- bg-pink-500

```typescript
const AVATAR_PALETTE = [
  { bg: 'bg-amber-500', text: 'text-white' },
  { bg: 'bg-orange-500', text: 'text-white' },
  { bg: 'bg-teal-500', text: 'text-white' },
  { bg: 'bg-rose-500', text: 'text-white' },
  { bg: 'bg-emerald-500', text: 'text-white' },
  { bg: 'bg-violet-500', text: 'text-white' },
  { bg: 'bg-sky-500', text: 'text-white' },
  { bg: 'bg-pink-500', text: 'text-white' },
] as const

export function getAvatarColorClasses(name: string) {
  if (!name) return AVATAR_PALETTE[0]
  const sum = Array.from(name).reduce((acc, ch) => acc + ch.charCodeAt(0), 0)
  return AVATAR_PALETTE[sum % AVATAR_PALETTE.length]
}
```

**2. Extend `src/components/domain/AvatarInitials.tsx`:**

Add optional `colorClassName` prop to the interface. When provided, use it on `AvatarFallback` instead of the default `bg-primary/10 text-primary`. The prop is a string of Tailwind classes (e.g. `"bg-amber-500 text-white"`).

Change the AvatarFallback className from hardcoded `"bg-primary/10 text-primary font-semibold"` to:
```tsx
<AvatarFallback className={cn(colorClassName || "bg-primary/10 text-primary", "font-semibold")}>
```

Also add a new `"xl"` size variant: `'h-16 w-16 text-lg'` — needed for the large avatar in the detail header gradient strip.

**3. Create `src/components/domain/DetailPageHeader.tsx`:**

Props interface:
```typescript
interface DetailPageHeaderProps {
  firstName?: string
  lastName?: string
  fullName?: string
  entityType: string            // "מורה" | "תלמיד" | "תזמורת" | "בגרות"
  breadcrumbLabel: string       // "מורים" | "תלמידים" | "תזמורות" | "בגרויות"
  breadcrumbHref: string        // "/teachers" | "/students" etc.
  updatedAt?: string | Date
  badges?: React.ReactNode      // flexible slot for status/role badges
  children?: React.ReactNode    // optional slot for action buttons below header
}
```

Implementation:
- Use `useNavigate()` from react-router-dom for breadcrumb link
- Import `getDisplayName` from `@/utils/nameUtils` for name display
- Import `getAvatarColorClasses` from `@/utils/avatarColorHash`
- Import `AvatarInitials` from `@/components/domain/AvatarInitials`
- Import `ChevronLeft` from `lucide-react` (in RTL, ChevronLeft is the visual forward-pointing arrow for breadcrumbs)

Structure (top to bottom):
1. **Breadcrumb nav** — above the gradient strip, same pattern as existing pages:
   ```tsx
   <nav className="flex items-center gap-2 text-sm text-muted-foreground mb-4">
     <button onClick={() => navigate(breadcrumbHref)} className="hover:text-primary transition-colors">
       {breadcrumbLabel}
     </button>
     <ChevronLeft className="w-4 h-4" />
     <span className="text-foreground font-medium">{displayName}</span>
   </nav>
   ```

2. **Gradient strip** — rounded card with warm gradient:

   Compute the avatar color from the display name using the deterministic hash:
   ```tsx
   const displayName = getDisplayName({ firstName, lastName, fullName })
   const avatarColor = getAvatarColorClasses(displayName)
   ```

   Then render:
   ```tsx
   <div className="bg-gradient-to-l from-primary to-accent rounded-xl p-6 text-white">
     <div className="flex items-center gap-4">
       <AvatarInitials
         firstName={firstName}
         lastName={lastName}
         fullName={fullName}
         size="xl"
         colorClassName={`${avatarColor.bg} ${avatarColor.text}`}
       />
       <div className="flex-1 min-w-0">
         <div className="flex items-center gap-3 flex-wrap">
           <h1 className="text-2xl font-bold truncate">{displayName}</h1>
           {badges}
         </div>
         {updatedAt && (
           <p className="text-white/80 text-sm mt-1">
             עודכן לאחרונה: {formatLastUpdated(updatedAt)}
           </p>
         )}
       </div>
     </div>
   </div>
   ```

   The `getAvatarColorClasses` call ensures deterministic per-name colors. Same name always gets same color across all pages.

   Use `from-primary to-accent` (CSS vars: warm coral to amber). Do NOT use `from-primary-500` (hardcoded blue).

3. **formatLastUpdated helper** (module-scoped):
   ```typescript
   function formatLastUpdated(date: string | Date): string {
     return new Date(date).toLocaleDateString('he-IL', {
       year: 'numeric', month: 'long', day: 'numeric'
     })
   }
   ```

4. **children slot** — renders below the gradient strip if provided (for action buttons, impact summary, etc.)

**4. Update `src/components/domain/index.ts`:**

Add export: `export { DetailPageHeader } from './DetailPageHeader'`
  </action>
  <verify>
- `grep -c "getAvatarColorClasses" src/utils/avatarColorHash.ts` returns at least 1
- `grep -c "getAvatarColorClasses" src/components/domain/DetailPageHeader.tsx` returns at least 2 (import + call)
- `grep -c "colorClassName" src/components/domain/AvatarInitials.tsx` returns at least 1
- `grep -c "DetailPageHeader" src/components/domain/DetailPageHeader.tsx` returns at least 1
- `grep -c "DetailPageHeader" src/components/domain/index.ts` returns 1
- `grep "from-primary-500" src/components/domain/DetailPageHeader.tsx` returns NO matches (must use from-primary, not from-primary-500)
- `grep "bg-white/20 text-white" src/components/domain/DetailPageHeader.tsx` returns NO matches (must use getAvatarColorClasses, not hardcoded)
  </verify>
  <done>
- avatarColorHash.ts exports getAvatarColorClasses with 8-color deterministic palette
- AvatarInitials accepts optional colorClassName prop and has xl size variant
- DetailPageHeader calls getAvatarColorClasses(displayName) and passes the result as colorClassName to AvatarInitials (deterministic per-name color, not hardcoded)
- DetailPageHeader renders gradient strip (from-primary to-accent), breadcrumb with ChevronLeft, avatar initials, badges slot, and Hebrew updatedAt date
- Domain barrel exports DetailPageHeader
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire DetailPageHeader and tab fade into Teacher and Student detail pages</name>
  <files>
    src/features/teachers/details/components/TeacherDetailsPage.tsx
    src/features/students/details/components/StudentDetailsPage.tsx
  </files>
  <action>
**TeacherDetailsPage.tsx:**

1. Add imports:
   - `import { DetailPageHeader } from '@/components/domain'`
   - `import { AnimatePresence, motion } from 'framer-motion'`

2. Remove the inline breadcrumb nav (lines ~163-174 with `<nav>` + `מורים` + `>` + name).

3. Remove the inline white card header (lines ~177-196 with `bg-white rounded-lg shadow-sm` + emoji icon + name + instrument + conductor badge).

4. Replace both with:
   ```tsx
   <DetailPageHeader
     firstName={teacher?.personalInfo?.firstName}
     lastName={teacher?.personalInfo?.lastName}
     fullName={teacher?.personalInfo?.fullName}
     entityType="מורה"
     breadcrumbLabel="מורים"
     breadcrumbHref="/teachers"
     updatedAt={teacher?.updatedAt}
     badges={
       <>
         <span className="px-3 py-1 bg-white/20 rounded-full text-sm font-medium">
           {teacher?.professionalInfo?.instrument || 'ללא כלי'}
         </span>
         {teacher?.roles?.map((role: string) => (
           <span key={role} className="px-3 py-1 bg-white/20 rounded-full text-sm font-medium">
             {role}
           </span>
         ))}
       </>
     }
   />
   ```

5. **Tab fade animation** — Restructure the Tabs content area. Instead of individual `<TabsContent>` blocks, use a single `AnimatePresence` wrapper with `forceMount` on TabsContent:

   After the `</TabsList>`, replace all TabsContent blocks with:
   ```tsx
   <AnimatePresence mode="wait">
     <motion.div
       key={activeTab}
       initial={{ opacity: 0 }}
       animate={{ opacity: 1 }}
       exit={{ opacity: 0 }}
       transition={{ duration: 0.2 }}
     >
       {activeTab === 'personal' && (
         <PersonalInfoTab teacher={teacher} teacherId={teacherId} />
       )}
       {activeTab === 'students' && (
         <StudentManagementTab teacher={teacher} teacherId={teacherId} />
       )}
       {activeTab === 'schedule' && (
         <ScheduleTab teacher={teacher} teacherId={teacherId} />
       )}
       {activeTab === 'conducting' && showConductingTab && (
         <ConductingTab teacher={teacher} teacherId={teacherId} />
       )}
       {activeTab === 'hours' && (
         <HoursSummaryTab teacher={teacher} teacherId={teacherId} />
       )}
     </motion.div>
   </AnimatePresence>
   ```

   Remove all `<TabsContent>` wrappers. The Radix Tabs `value` still controls which tab trigger is active, but content rendering is handled by the conditional + AnimatePresence pattern. This avoids the Radix hidden-panel issue where all panels stay in DOM.

6. Clean up unused imports: remove `ArrowRight` if no longer used in the main return (error states still use it, keep if needed).

**StudentDetailsPage.tsx:**

1. Add imports:
   - `import { DetailPageHeader } from '@/components/domain'`
   - `import { AnimatePresence, motion } from 'framer-motion'`

2. Remove the inline breadcrumb nav (lines ~356-367 with `תלמידים` + `>` + name).

3. Remove the inline white card header (lines ~370-424 with emoji icon, name, class/instrument, action buttons). Move the action buttons into the `children` slot or a separate div beneath the DetailPageHeader.

4. Replace with:
   ```tsx
   <DetailPageHeader
     firstName={student?.personalInfo?.firstName}
     lastName={student?.personalInfo?.lastName}
     fullName={student?.personalInfo?.fullName}
     entityType="תלמיד"
     breadcrumbLabel="תלמידים"
     breadcrumbHref="/students"
     updatedAt={student?.updatedAt}
     badges={
       <>
         <span className="px-3 py-1 bg-white/20 rounded-full text-sm font-medium">
           כיתה {student?.academicInfo?.class || '-'}
         </span>
         <span className="px-3 py-1 bg-white/20 rounded-full text-sm font-medium">
           {student?.primaryInstrument || 'ללא כלי'}
         </span>
       </>
     }
   />
   ```

5. Keep the action buttons (delete, safe delete, check references, impact toggle) as a separate div below DetailPageHeader, matching the existing layout.

6. **Tab fade animation** — Same pattern as Teacher. Replace all TabsContent blocks with single AnimatePresence + motion.div + conditional rendering per activeTab. Student has 8 tabs: personal, academic, schedule, attendance, orchestra, theory, bagrut, documents. Keep the `<Suspense fallback={<TabLoadingFallback />}>` wrappers inside each conditional.

   ```tsx
   <AnimatePresence mode="wait">
     <motion.div
       key={activeTab}
       initial={{ opacity: 0 }}
       animate={{ opacity: 1 }}
       exit={{ opacity: 0 }}
       transition={{ duration: 0.2 }}
     >
       {activeTab === 'personal' && (
         <Suspense fallback={<TabLoadingFallback />}>
           <PersonalInfoTab student={student} studentId={studentId} onStudentUpdate={handleStudentUpdate} />
         </Suspense>
       )}
       {/* ... same pattern for all 8 tabs */}
     </motion.div>
   </AnimatePresence>
   ```

**CRITICAL:** Do NOT use `bg-primary-500` or `bg-primary-600` for any NEW elements. Use `bg-primary` (CSS var, warm coral). Existing error states that use these can stay for now (Phase 13 polish).
  </action>
  <verify>
- `grep "DetailPageHeader" src/features/teachers/details/components/TeacherDetailsPage.tsx` matches import and usage
- `grep "AnimatePresence" src/features/teachers/details/components/TeacherDetailsPage.tsx` matches at least 1
- `grep "motion.div" src/features/teachers/details/components/TeacherDetailsPage.tsx` matches at least 1
- `grep "DetailPageHeader" src/features/students/details/components/StudentDetailsPage.tsx` matches import and usage
- `grep "AnimatePresence" src/features/students/details/components/StudentDetailsPage.tsx` matches at least 1
- Breadcrumb nav with `>` separator is gone from both files (no `<span>{'>'}</span>` pattern)
- Old white card headers with emoji icons are gone from main return (error states may still have emoji)
  </verify>
  <done>
- TeacherDetailsPage uses DetailPageHeader with gradient strip, avatar initials, breadcrumb with ChevronLeft, role badges, and updatedAt
- StudentDetailsPage uses DetailPageHeader with gradient strip, avatar initials, breadcrumb, class/instrument badges, and updatedAt
- Both pages have 200ms fade transition when switching tabs via AnimatePresence + motion.div
- No `from-primary-500` (blue) in new code — only `from-primary` (warm coral via CSS var)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `grep -r "from-primary-500" src/components/domain/DetailPageHeader.tsx` — MUST return empty (uses from-primary)
2. `grep -r "DetailPageHeader" src/features/teachers/ src/features/students/` — shows imports in both pages
3. `grep -r "AnimatePresence" src/features/teachers/ src/features/students/` — shows animation wired in both
4. `grep -r "getAvatarColorClasses" src/utils/avatarColorHash.ts` — utility exists
5. `grep "xl:" src/components/domain/AvatarInitials.tsx` or `grep "'xl'" src/components/domain/AvatarInitials.tsx` — xl size variant exists
6. `grep "עודכן לאחרונה" src/components/domain/DetailPageHeader.tsx` — Hebrew updatedAt label exists
</verification>

<success_criteria>
- Teacher detail page header has warm gradient strip (from-primary to-accent), avatar initials with xl size and deterministic hashed color, breadcrumb "מורים > שם", updatedAt beneath name, and role/instrument badges
- Student detail page has same structure with "תלמידים > שם", class and instrument badges
- Tab switching shows 200ms opacity fade on both pages
- Avatar color is deterministic: same name always produces same color
- No `bg-primary-500` or `from-primary-500` in any new code
</success_criteria>

<output>
After completion, create `.planning/phases/11-detail-pages/11-01-SUMMARY.md`
</output>
